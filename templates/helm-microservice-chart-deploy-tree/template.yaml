parameters:
  # Required
  - name: "COMMAND"
    type: string
    default: "upgrade"
  - name: "DO_DEPLOY"
    displayName: '(Required) Launch helm deploy.'
    type: boolean
  - name: "ENV"
    type: string
    displayName: '(Required) Which environment is involved into deploy.'
  - name: "KUBERNETES_SERVICE_CONN"
    type: string
    displayName: '(Required) Azure devops service connection name.'
  - name: "NAMESPACE"
    type: string
    displayName: '(Required) Kubernetes namespace.'
  - name: "APP_NAME"
    type: string
    displayName: '(Required) Helm deploy name.'
  - name: "DEPLOY_VERSION"
    type: string
    displayName: '(Required) Deploy image tag version.'
  # Optional
  - name: "WAIT_FOR_EXECUTION"
    type: boolean
    default: true
  - name: "ARGUMENTS"
    type: string
    default: "--timeout 5m0s"
  - name: "APPINSIGHTS_SERVICE_CONN"
    type: string
    default: "none"
  - name: "APPINSIGHTS_RESOURCE_ID"
    type: string
    default: "none"
  - name: "OVERRIDE_EXTENDS" # https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/helm-deploy-v0?view=azure-pipelines
    type: string
    default: ""
    displayName: ",key1=val1,key2=val2"




steps:
  - checkout: self
  # 1. Setup helm
  - template: ../helm-microservice-chart-setup/template.yaml@helm
    parameters:
      DEPLOY_VERSION: ${{parameters.DEPLOY_VERSION}}
      HELM_DEPENDECIES_COMMAND: 'build'
      CHART_FILE: '${{parameters.ENV}}/${{parameters.APP_NAME}}/Chart.yml'
      VALUES_FILE: '${{parameters.ENV}}/${{parameters.APP_NAME}}/values.yml'
  - template: ../helm-microservice-chart-deploy/template.yaml@helm
    parameters:
      DO_DEPLOY : true
      COMMAND: ${{parameters.COMMAND}}
      ENV: ${{parameters.ENV}}
      KUBERNETES_SERVICE_CONN: ${{parameters.KUBERNETES_SERVICE_CONN}}
      NAMESPACE: ${{parameters.NAMESPACE}}
      APP_NAME: ${{parameters.APP_NAME}}
      CHART_TYPE: "filepath"
      CHART_PATH: '${{parameters.ENV}}/${{parameters.APP_NAME}}/Chart.yml'
      VALUE_FILE: '${{parameters.ENV}}/${{parameters.APP_NAME}}/values.yml'
      DEPLOY_VERSION: ${{parameters.DEPLOY_VERSION}}
      WAIT_FOR_EXECUTION: ${{parameters.WAIT_FOR_EXECUTION}}
      ARGUMENTS: ${{parameters.ARGUMENTS}}
      APPINSIGHTS_SERVICE_CONN: ${{parameters.APPINSIGHTS_SERVICE_CONN}}
      APPINSIGHTS_RESOURCE_ID: ${{parameters.APPINSIGHTS_RESOURCE_ID}}
      OVERRIDE_EXTENDS: ${{parameters.OVERRIDE_EXTENDS}}
