# Azure DevOps pipeline template to upgrade yarn.lock file

parameters:

  - name: 'projectDir'
    type: string
    default: '.'

# ------------------
# Test parameters only


# ------------------
# Steps 

steps:

  #Needed for git to work
  - checkout: self
    clean: true
    persistCredentials: true
    displayName: 'Checkout'

  # setup git author
  - script: |
      git config --global user.email "$(GIT_EMAIL)" && git config --global user.name "$(GIT_USERNAME)"


      #setup hub CLI
      echo "github.com: 
      - user: $GITHUB_USERNAME
        oauth_token: $GITHUB_TOKEN" > ~/.config/hub

      ls ~/.config
      cat ~/.config/hub
 

    displayName: 'Git setup' 

  - script: |

      ls ~/.config

      hub version
      # hub pr list

    displayName: Test hub CLI


  - script: |
      echo "" > ~/.config/hub
    displayName: Cleanup





  # - script: |
      
  #     set -euo pipefail
      
  #     echo "------> 1"
  #     git config --global user.email "$(GIT_EMAIL)" && git config --global user.name "$(GIT_USERNAME)"
  #     git config --global hub.protocol https

  #     echo $(GITHUB_CONNECTION)
      
  #     yarn install
  #     lockfile_changed=`git ls-files -m | grep yarn.lock`
  #     echo "lockfile_changed => $lockfile_changed"
     
  #     if [ -n "$lockfile_changed" ]
  #     then
  #         echo "------> 2"
          
  #         title="[Yarn.lock update] Update yarn.lock file"
  #         description="Autogenerated PR for updating yarn.lock file"
          
  #         branch_name="lockfile-upgrade-$(date +%s)"
          
  #         git checkout -b "$branch_name"
  #         git add yarn.lock
  #         git commit -m "$title"
  #         #git push origin "$branch_name"
          
  #         echo "------> 3"

  #         #hub pull-request -m "$title" -m "$description" 
          
  #         echo "------> 4"
  #     fi
      
  #   workingDirectory: ${{ parameters.projectDir }}

  
