# Azure DevOps pipeline template to upgrade yarn.lock file

parameters:

  - name: 'projectDir'
    type: string
    default: '.'

# ------------------
# Test parameters only


# ------------------
# Steps 

steps:

  #Needed for git to work
  - checkout: self
    clean: true
    persistCredentials: true
    displayName: 'Checkout'

  # setup git author
  - script: |
      git config --global user.email "$(GIT_EMAIL)" && git config --global user.name "$(GITHUB_USERNAME)"

      #setup hub CLI
      echo "github.com: 
      - user: $GITHUB_USERNAME
        oauth_token: $(GITHUB_TOKEN)" > ~/.config/hub

    displayName: 'Git setup' 

  - script: |
      
      set -euo pipefail
      
      # It should be 'master', but right now it has no files in it
      #git checkout master

      yarn install
      lockfile_changed=`git ls-files -m | grep yarn.lock`
      echo "lockfile_changed => $lockfile_changed"
     
      if [ -n "$lockfile_changed" ]
      then
          echo "Yarn.lock has changed, create a PR"

          title="[Yarn.lock Upgrade] Upgrade yarn.lock file"
          description="Autogenerated PR for upgrading yarn.lock file"
          
          branch_name="lockfile-upgrade-$(date +%s)"
          
          git checkout -b "$branch_name"
          git add yarn.lock
          git commit -m "$title"
          
          git push origin "$branch_name"
          hub pull-request -m "$title" -m "$description" 
      fi
      
    workingDirectory: ${{ parameters.projectDir }}


  - script: |
      echo "" > ~/.config/hub
    displayName: Cleanup
