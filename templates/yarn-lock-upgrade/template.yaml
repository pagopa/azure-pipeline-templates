# Azure DevOps pipeline template to upgrade yarn.lock file

parameters:

  - name: 'projectDir'
    type: string
    default: '.'

# ------------------
# Test parameters only


# ------------------
# Steps 

steps:

  #Needed for git to work
  - checkout: self
    clean: true
    persistCredentials: true
    displayName: 'Checkout'

  # setup git author
  - script: |
      git config --global user.email "$(GITHUB_EMAIL)" && git config --global user.name "$(GITHUB_USERNAME)"

      #setup hub CLI
      echo "github.com: 
      - user: $GITHUB_USERNAME
        oauth_token: $(GITHUB_TOKEN)" > ~/.config/hub

    displayName: 'Git setup' 

  - script: |
      set -euo pipefail

      #| grep "\[Yarn.lock Upgrade\]" | awk '{print $1}' | sed 's/#//'
      PR_NUMBER=`hub pr list | grep "Yarn"`
      echo "==> PR $PR_NUMBER"
      
      TEST_VAR=`hub pr list | grep "\[proposal\]" | awk '{print $1}' | sed 's/#//'`
      
      echo "==> $TEST_VAR <=="
    
    displayName: "Check yarn.lock file and make PR if needed"
    workingDirectory: ${{ parameters.projectDir }}


  - script: |
      echo "" > ~/.config/hub
    displayName: Cleanup
